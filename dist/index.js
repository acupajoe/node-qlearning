var items=[],History=function(){function t(){}return Object.defineProperty(t.prototype,"items",{get:function(){return items},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return items.length},enumerable:!0,configurable:!0}),t.prototype.push=function(t,e,n){this.items.push({state:t,action:e,reward:n})},t.prototype.clear=function(){items=[]},t}(),State=function(){function t(t){this.state=t}return Object.defineProperty(t.prototype,"hash",{get:function(){return JSON.stringify(this.state)},enumerable:!0,configurable:!0}),t}(),fs=require("fs"),colors=require("colors"),sortBy=require("lodash").sortBy,isVerbose=!1,Log=function(t){isVerbose&&console.log(t)},QLearning=function(){function t(t,e,n){return this.name=t,this.actions=e,this.state=null,this.alpha=n||.5,this.policy={},this.history=new History,this.functions={cost:null,reward:null,printer:null,stateGenerator:null},this}return Object.defineProperty(t.prototype,"verbose",{set:function(t){isVerbose=t},enumerable:!0,configurable:!0}),t.prototype.setState=function(t){return this.state=t instanceof State?t:new State(t),this.history.push(this.state,null,null),this},t.prototype.setCost=function(t){if("function"!=typeof t)throw new Error("Cost must be defined as a function");return this.functions.cost=t,this},t.prototype.setReward=function(t){if("function"!=typeof t)throw new Error("Reward must be defined as a function");return this.functions.reward=t,this},t.prototype.setPrinter=function(t){if("function"!=typeof t)throw new Error("Printer must be defined as a function");return this.functions.printer=t,this},t.prototype.setStateGenerator=function(t){if("function"!=typeof t)throw new Error("State Generator must be defined as a function");return this.functions.stateGenerator=t,this},t.prototype.perceiveState=function(){return this.history.push(null,this.state,null),this},t.prototype.start=function(t){if(!this.functions.cost)throw new Error("Cost function must be defined before calling `start`");if(!this.functions.stateGenerator)throw new Error("State Generation function must be defined before calling `start`");if(!this.functions.reward)throw new Error("Reward function must be defined before calling `start`");return this.history.clear(),this.setState(t),this},t.prototype.learn=function(){var t,e,n,r,i,o=this.history.length;if(o<2)throw new Error("Agent has not moved - cannot learn yet!");if(t=this.history.items[o-2],e=this.history.items[o-1],null===t.action)throw new Error("Agent should perceive the current state after its last moving");if(null!==e.action)throw new Error("Agent should update the current state after moving");return n=this.functions.reward.call(this,t.state),r=this.functions.reward.call(this,e.state),i=this.alpha*(r-n),this.__updatePolicy(t.state,t.action,i),this},t.prototype.step=function(){Log("Begin Step".green);var t,e,n;if(!this.state)throw new Error("Agent must have a state assigned - use `setState()`");return t=this.__explore(this.state),e=t[0],this.history.push(this.state,e.action,null),Log((""+this.name).red+" chose action: ".green+e.action),n=this.functions.stateGenerator(this.state,e.action),this.state=n instanceof State?n:new State(n),this.functions.printer&&this.functions.printer(this.state),this},t.prototype.save=function(t){return fs.writeFileSync(t+"/"+this.name+".agent",JSON.stringify(this.policy)),this},t.prototype.saveAs=function(t,e){return fs.writeFileSync(t+"/"+e+".agent",JSON.stringify(this.policy)),this},t.prototype.load=function(t){if(fs.existsSync(t+"/"+this.name+".agent")){var e=fs.readFileSync(t+"/"+this.name+".agent");return e=JSON.parse(e),this.policy=e,Log("Agent Loaded".green),this}return this},t.prototype.__explore=function(t){var e=this,n=this.actions.map(function(n){var r=e.__predict(t,n);return 0===r&&(r+=Math.random()),{action:n,reward:r}});return sortBy(n,function(t){return-t.reward})},t.prototype.__predict=function(t,e){var n=this.functions.cost(t,e);if(n<0)return n;if(this.policy.hasOwnProperty(t.hash)){var r=this.policy[t.hash].filter(function(t){return t.action=e});return 0===r.length?this.functions.cost(t,e):r[0].reward}if(this.theta){Log("Retrieving policy from generation".yellow);this.actions.lastIndexOf(e);return n}return n},t.prototype.__updatePolicy=function(t,e,n){return this.policy.hasOwnProperty(t.hash)?this.policy[t.hash]=this.policy[t.hash].map(function(t){return t.action===e?{action:e,reward:n}:{action:t.action,reward:t.reward}}):(this.policy[t.hash]=[],this.policy[t.hash]=this.actions.map(function(t){return{action:t,reward:t===e?n:0}})),this.policy[t.hash]=sortBy(this.policy[t.hash],function(t){return-t.reward}),this},t}();export{History,State};export default QLearning;
